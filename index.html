<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisse Senedi Portföy Takip</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --primary-color: #1e1e1e;
            --secondary-color: #2a2a2a;
            --text-color: #e0e0e0;
            --text-muted-color: #a0a0a0;
            --accent-color: #03dac6;
            --green-color: #4caf50;
            --red-color: #f44336;
            --border-color: #3a3a3a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1600px; margin: 20px auto; padding: 20px; background-color: var(--primary-color); border-radius: 8px; }
        nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        nav button { background: none; border: none; color: var(--text-muted-color); padding: 15px 20px; cursor: pointer; font-size: 16px; transition: color 0.3s, border-bottom 0.3s; border-bottom: 3px solid transparent; }
        nav button.active { color: var(--accent-color); border-bottom: 3px solid var(--accent-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        h2, h3 { color: var(--text-color); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background-color: var(--secondary-color); padding: 20px; border-radius: 8px; border-left: 4px solid var(--accent-color); }
        .card .label { font-size: 14px; color: var(--text-muted-color); }
        .card .value { font-size: 24px; font-weight: bold; margin-top: 5px; }
        .value.positive { color: var(--green-color); }
        .value.negative { color: var(--red-color); }
        td.positive { color: var(--green-color); font-weight: bold; }
        td.negative { color: var(--red-color); font-weight: bold; }

        .form-section, .kasa-section, .section { background-color: var(--secondary-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        input, select, textarea, button { width: 100%; padding: 10px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; font-size: 14px; }
        textarea { resize: vertical; min-height: 100px; }
        button { background-color: var(--accent-color); color: var(--bg-color); border: none; cursor: pointer; font-weight: bold; transition: background-color 0.3s; }
        button:hover { background-color: #018786; }
        .button-group { display: flex; gap: 10px; margin-top: 10px; }
        .button-group button { width: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 8px; text-align: left; font-size: 13px; white-space: nowrap; }
        thead { background-color: var(--secondary-color); }
        tbody tr { height: 20px; transition: background-color 0.2s; }
        tbody tr:hover { background-color: #2c2c2c; }
        td .action-btn { background: none; border: none; cursor: pointer; padding: 2px 8px; color: var(--text-muted-color); font-size: 16px; min-width: 30px; }
        td .action-btn:hover { color: var(--accent-color); }
        #kasaChartContainer, #karsilastirmaChartContainer { margin-top: 20px; padding: 20px; background-color: var(--secondary-color); border-radius: 8px; }
        .filter-buttons { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-buttons button { background-color: var(--secondary-color); color: var(--text-muted-color); border: 1px solid var(--border-color); padding: 8px 12px; font-size: 12px; width: auto; }
        .filter-buttons button.active { background-color: var(--accent-color); color: var(--bg-color); border-color: var(--accent-color); }
        #kapaliPozisyonlarContainer { display: none; }
        #toggleKapaliPozisyonlar { background-color: var(--secondary-color); width: 100%; margin-top: 20px; text-align: left; padding: 15px; border-radius: 5px; border: 1px solid var(--border-color); }
        
        .note-list { list-style: none; margin-top: 30px; padding: 0; }
        .note-item { background-color: transparent; padding: 18px 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .note-item:hover { background-color: #252525; }
        .note-item p { flex-grow: 1; margin-right: 15px; line-height: 1.5; }
        .note-item .note-actions { display: flex; gap: 5px; }
        .note-item .action-btn { padding: 5px 10px; font-size: 16px; }
        .note-control-btn { padding: 8px 16px !important; font-size: 13px !important; width: auto !important; flex-grow: 0 !important; }
        .note-control-btn.secondary { background-color: #3a3a3a; color: var(--text-muted-color); }
        .note-control-btn.secondary:hover { background-color: #4a4a4a; }
        #not-defteri .button-group { justify-content: flex-start; }
        
        .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        #kasaChartContainer { margin-top: 0; }
        @media (max-width: 1024px) { .charts-grid { grid-template-columns: 1fr; } }
        
        #kapaliPozisyonlarTable thead th[data-sort-key] { cursor: pointer; position: relative; -webkit-user-select: none; user-select: none; }
        #kapaliPozisyonlarTable thead th[data-sort-key]:hover { background-color: #3a3a3a; }
        .sort-indicator { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--accent-color); font-size: 14px; }

        .summary-trades-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .trade-summary-card h3 { border: none; padding: 0; margin-bottom: 15px; font-size: 18px; }
        .trade-summary-card.positive-trade { border-left-color: var(--green-color); }
        .trade-summary-card.negative-trade { border-left-color: var(--red-color); }
        .trade-summary-card .placeholder { color: var(--text-muted-color); }
        .trade-summary-card .trade-details p { margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .trade-summary-card .trade-details span { font-weight: bold; }
        .trade-summary-card .trade-details .hisse-adi { font-size: 24px; font-weight: bold; color: var(--text-color); margin-bottom: 12px; }
        .trade-summary-card .trade-details .pnl-value { font-size: 20px; }
        .trade-summary-card a { color: var(--accent-color); text-decoration: none; }
        .trade-summary-card a:hover { text-decoration: underline; }
        @media (max-width: 768px) { .summary-trades-grid { grid-template-columns: 1fr; } }

        .loader { color: var(--text-muted-color); font-size: 14px; text-align: center; padding: 40px; }
    </style>
</head>
<body>

<div class="container">
    <nav>
        <button class="tab-button active" data-tab="dashboard">Dashboard</button>
        <button class="tab-button" data-tab="islemler">İşlemler</button>
        <button class="tab-button" data-tab="analiz">Analiz</button>
        <button class="tab-button" data-tab="karsilastirma">Karşılaştırma</button>
        <button class="tab-button" data-tab="not-defteri">Not Defteri</button>
    </nav>
    <div id="dashboard" class="tab-content active">
        <h2>Genel Bakış</h2>
        <div class="grid">
            <div class="card"><div class="label">Toplam Getiri (%)</div><div id="dashboard-toplam-getiri-yuzde" class="value">0.00%</div></div>
            <div class="card"><div class="label">Toplam Getiri (TL)</div><div id="dashboard-toplam-getiri-tl" class="value">0.00 TL</div></div>
            <div class="card"><div class="label">Kazanma Oranı (Win Rate)</div><div id="dashboard-kazanma-orani" class="value">0.00%</div></div>
            <div class="card"><div class="label">Profit Factor</div><div id="dashboard-profit-factor" class="value">0.00</div></div>
            <div class="card"><div class="label">Tamamlanan İşlem</div><div id="dashboard-tamamlanan-islem" class="value">0</div></div>
            <div class="card"><div class="label">Ortalama Pozisyon Süresi</div><div id="dashboard-ortalama-gun" class="value">0 gün</div></div>
            <div class="card" style="grid-column: 1 / -1;"><div class="label">Güncel Kasa Değeri</div><div id="dashboard-guncel-kasa" class="value">0.00 TL</div></div>
        </div>
        <div class="charts-grid">
            <div id="kasaChartContainer">
                <h3>Kasa Değerinin Zamana Göre Değişimi</h3>
                <div class="filter-buttons">
                    <button id="kasa-try-btn" class="active">TRY</button><button id="kasa-usd-btn">USD</button><button id="kasa-reel-btn">Reel</button>
                </div>
                <canvas id="kasaChart"></canvas>
            </div>
            <div class="card" style="display: flex; flex-direction: column;">
                 <h3 style="border:none; padding:0; margin-bottom:15px;">Kazanma Oranı</h3>
                 <div style="position: relative; flex-grow: 1; display: flex; align-items: center; justify-content: center;">
                    <canvas id="winRatePieChart"></canvas>
                 </div>
            </div>
        </div>
    </div>
    <div id="islemler" class="tab-content">
        <div class="kasa-section">
             <h3>Kasa Yönetimi</h3>
             <div class="form-grid">
                 <div><label for="baslangicKasa">Başlangıç Kasası (TL)</label><input type="number" id="baslangicKasa" placeholder="100000"></div>
                 <div><label for="kasaIslemTutar">Ekle/Çıkar Tutar (TL)</label><input type="number" id="kasaIslemTutar" placeholder="5000"></div>
                 <div style="align-self: flex-end;"><div class="button-group"><button id="kasaEkleBtn">Kasaya Ekle</button><button id="kasaCikarBtn" style="background-color:#d32f2f;">Kasadan Çıkar</button></div></div>
                 <div style="align-self: flex-end;">
                    <div class="button-group" style="margin-top:0;">
                        <button id="kasaKaydetBtn">Başlangıç Kasasını Kaydet</button>
                        <button id="tumunuSilBtn" style="background-color:#c62828;">Tüm Pozisyonları Sil</button>
                    </div>
                 </div>
             </div>
        </div>
        <div class="form-section">
            <h3>Tekil İşlem Girişi</h3>
            <div class="form-grid">
                <input type="hidden" id="editIndex">
                <input type="text" id="hisse" placeholder="Hisse Kodu (örn: EREGL)" list="hisse-listesi">
                <input type="number" id="girisLot" placeholder="Giriş Lot">
                <input type="number" id="girisFiyat" placeholder="Giriş Fiyatı">
                <input type="date" id="girisTarihi">
                <input type="text" id="tradingviewLink" placeholder="TradingView Linki (opsiyonel)">
                <div style="align-self: flex-end;">
                    <button id="islemEkleBtn">Yeni Pozisyon Ekle</button>
                </div>
            </div>
            <datalist id="hisse-listesi"></datalist>
        </div>
        <div class="section">
            <h3>Açık Pozisyonlar</h3>
            <table id="acikPozisyonlarTable">
                <thead>
                    <tr>
                        <th>Hisse</th><th>Poz. Büyüklüğü (%)</th><th>Giriş Tarihi</th><th>Giriş Lot</th><th>Giriş Fiyatı</th><th>Güncel Fiyat</th>
                        <th>Çıkış Tarihi</th><th>Çıkış Lot</th><th>Çıkış Fiyatı</th><th>Gün</th><th>Fee (TL)</th>
                        <th>Net PnL (%)</th><th>Net PnL (TL)</th><th>Kasaya Etkisi (%)</th><th>Link</th><th>İşlemler</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button id="toggleKapaliPozisyonlar">Kapalı Pozisyonları Göster/Gizle</button>
        <div id="kapaliPozisyonlarContainer" class="section">
            <h3>Kapalı Pozisyonlar</h3>
            <table id="kapaliPozisyonlarTable">
                <thead>
                    <tr>
                        <th data-sort-key="hisse">Hisse</th>
                        <th>Poz. Büyüklüğü (%)</th>
                        <th data-sort-key="girisTarihi">Giriş Tarihi</th>
                        <th>Giriş Lot</th>
                        <th>Giriş Fiyatı</th>
                        <th>Güncel Fiyat</th>
                        <th data-sort-key="cikisTarihi">Çıkış Tarihi</th>
                        <th>Çıkış Lot</th>
                        <th>Çıkış Fiyatı</th>
                        <th data-sort-key="gun">Gün</th>
                        <th>Fee (TL)</th>
                        <th data-sort-key="netPnlYuzde">Net PnL (%)</th>
                        <th data-sort-key="netPnlTL">Net PnL (TL)</th>
                        <th data-sort-key="kasayaEtkisi">Kasaya Etkisi (%)</th>
                        <th>Link</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div id="analiz" class="tab-content">
        <h2>Performans Analizi</h2>
        <div class="filter-buttons" id="analiz-filter"><button class="active" data-period="all">Tümü</button><button data-period="ytd">Yıl Başından Beri</button><button data-period="1y">Son 1 Yıl</button><button data-period="1q">Son Çeyrek</button><button data-period="30d">Son 30 Gün</button><button data-period="7d">Son 7 Gün</button></div>
        
        <div class="grid" id="analiz-grid"></div>

        <div class="summary-trades-grid">
            <div class="card trade-summary-card positive-trade">
                <h3>En Başarılı İşlem</h3>
                <div id="best-trade-content">
                    <p class="placeholder">Bu dönemde kazanan işlem bulunmuyor.</p>
                </div>
            </div>
            <div class="card trade-summary-card negative-trade">
                <h3>En Öğretici İşlem</h3>
                <div id="worst-trade-content">
                    <p class="placeholder">Bu dönemde kaybeden işlem bulunmuyor.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="karsilastirma" class="tab-content">
        <h2>Getiri Karşılaştırması</h2>
        <div class="filter-buttons" id="karsilastirma-filter"><button class="active" data-period="ytd">Yıl Başından Beri</button><button data-period="1y">Son 1 Yıl</button><button data-period="1q">Son Çeyrek</button><button data-period="30d">Son 30 Gün</button><button data-period="7d">Son 7 Gün</button></div>
        <div class="filter-buttons"><button id="nominal-btn" class="active">Nominal Getiri</button><button id="reel-btn">Reel Getiri</button></div>
        <div id="karsilastirmaChartContainer">
            <canvas id="karsilastirmaChart"></canvas>
        </div>
    </div>
    <div id="not-defteri" class="tab-content">
        <h2>Not Defteri</h2>
        <div class="note-form">
            <input type="hidden" id="noteEditIndex">
            <textarea id="noteInput" placeholder="Notunuzu buraya yazın..."></textarea>
            <div class="button-group" style="margin-top: 15px;">
                <button id="addNoteBtn" class="note-control-btn">Not Ekle</button>
                <button id="exportNotesBtn" class="note-control-btn secondary">Notları Dışa Aktar</button>
                <button id="importNotesBtn" class="note-control-btn secondary">Notları İçe Aktar</button>
            </div>
            <input type="file" id="importNotesInput" accept=".txt" style="display:none;">
        </div>
        <ul id="noteList" class="note-list"></ul>
    </div>
</div>
<div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:var(--secondary-color); padding:30px; border-radius:8px; width:90%; max-width:500px;">
        <h3 id="modalTitle">Pozisyon Kapat</h3>
        <div class="form-grid">
            <input type="hidden" id="modalIndex">
            <div><label>Çıkış Fiyatı</label><input type="number" id="modalCikisFiyat" placeholder="Çıkış Fiyatı"></div>
            <div><label>Çıkış Lot</label><input type="number" id="modalCikisLot" placeholder="Kapatılacak Lot"></div>
            <div><label>Çıkış Tarihi</label><input type="date" id="modalCikisTarihi"></div>
        </div>
        <div class="button-group" style="margin-top:20px;"><button id="modalKaydetBtn">Kaydet</button><button id="modalKapatBtn" style="background-color:#777;">İptal</button></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const FEE_RATE = 0.00092;
    let state = {
        transactions: [],
        kasa: { baslangic: 100000, hareketler: [] },
        notes: [],
        activeTab: 'dashboard',
        sortState: { key: 'cikisTarihi', order: 'desc' }, 
    };
    let kasaChartInstance = null;
    let karsilastirmaChartInstance = null;
    let winRatePieChartInstance = null; 

    const BIST_SYMBOLS = ["ACSEL", "ADEL", "ADESE", "ADNAC", "AEFES", "AFYON", "AGHOL", "AGYO", "AKBNK", "AKCNS", "AKENR", "AKFGY", "AKGRT", "AKMGY", "AKSA", "AKSEN", "ALARK", "ALBRK", "ALCAR", "ALCTL", "ALGYO", "ALKIM", "ANELE", "ANHYT", "ANSGR", "ARCLK", "ARENA", "ARMDA", "ARSAN", "ASELS", "ASLAN", "ASUZU", "ATAGY", "ATEKS", "ATLAS", "AYEN", "AYGAZ", "BAGFS", "BAKFG", "BANVT", "BERA", "BIMAS", "BIZIM", "BJKAS", "BMSCH", "BMSTL", "BOLUC", "BOSSA", "BOYNR", "BRISA", "BRKSN", "BRSAN", "BRYAT", "BSOKE", "BTCIM", "BUCIM", "BURCE", "BURVA", "CEMAS", "CEMTS", "CEOEM", "CIMSA", "CLEBI", "CMBTN", "CCOLA", "CUSAN", "DAGHL", "DAGI", "DARDL", "DENGE", "DENIZ", "DERAS", "DERIM", "DESA", "DESPC", "DEVA", "DGATE", "DGKLB", "DITAS", "DOAS", "DOBUR", "DOCO", "DOGUB", "DOHOL", "DOKTA", "ECILC", "ECZYT", "EDIP", "EGEEN", "EGGUB", "EGPRO", "EGSER", "EKGYO", "EMKEL", "ENJSA", "ENKAI", "ERBOS", "EREGL", "ERSU", "ESCOM", "ETILR", "EUHOL", "EUYO", "FENER", "FLAP", "FMIZP", "FONET", "FORMT", "FROTO", "GARAN", "GARFA", "GENTS", "GEREL", "GLBMD", "GLRYH", "GLYHO", "GOLTS", "GOODY", "GOZDE", "GRNYO", "GSDDE", "GSDHO", "GSRAY", "GUBRF", "GUSGR", "HALKB", "HALKS", "HATEK", "HDFGS", "HEKTS", "HLGYO", "HURGZ", "ICBCT", "IDEAS", "IDGYO", "IEYHO", "IHEVA", "IHGZT", "IHLAS", "IHLGM", "IHYAY", "INDES", "INFO", "INTEM", "IPEKE", "ISBIR", "ISCTR", "ISDMR", "ISFIN", "ISGYO", "ISGSY", "ISMEN", "ITTFH", "IZFAS", "IZMDC", "IZOCM", "JANTS", "KAPLM", "KAREL", "KARSN", "KARTN", "KCHOL", "KENT", "KERVT", "KLGYO", "KLMSN", "KONYA", "KORDS", "KOZAA", "KOZAL", "KRDMD", "KRSTL", "KRTEK", "KUYAS", "LIDFA", "LINK", "LKMNH", "LOGO", "LUKSK", "MAALT", "MAKTK", "MARKA", "MARTI", "MAVI", "MEGAP", "MEPET", "MERCN", "METRO", "MGROS", "MIPAZ", "MMCAS", "MNDRS", "MRGYO", "MRSHL", "MSGYO", "MTRYO", "MUTLU", "MZHLD", "NETAS", "NIBAS", "NTTUR", "NUHCM", "NUGYO", "ODAS", "OLMKS", "ORCAY", "ORGE", "ORMA", "OSMEN", "OSTIM", "OTKAR", "OYAKC", "OYLUM", "OZBAL", "OZGYO", "OZKGY", "PAGYO", "PARSN", "PEGYO", "PENGD", "PETKM", "PETUN", "PGSUS", "PINSU", "PKART", "PLAS", "POLHO", "PRKME", "PRZMA", "PSDTC", "PTOFS", "QNBFB", "QNBFL", "RALYH", "RAYSG", "RHEA", "RODRG", "ROYAL", "RTALB", "RYGYO", "SAFKR", "SAHOL", "SANKO", "SARKY", "SASA", "SEKUR", "SELEC", "SELGD", "SERVE", "SISE", "SKBNK", "SNGYO", "SODSN", "SOKM", "SONME", "SRVGY", "SUMAS", "TATGD", "TAVHL", "TBORG", "TCELL", "TCML", "TEKTU", "THYAO", "TKFEN", "TKNSA", "TMSN", "TOASO", "TRCAS", "TRGYO", "TRKCM", "TSKB", "TSPOR", "TTKOM", "TTRAK", "TUKAS", "TUPRS", "TURGG", "ULKER", "UNYEC", "USAK", "UTPYA", "VAKBN", "VAKFN", "VAKKO", "VANGD", "VERTU", "VESTL", "VKGYO", "VKING", "YAPRK", "YATAS", "YAZIC", "YESIL", "YGGYO", "YGYO", "YKBNK", "YKGYO", "YUNSA", "ZOREN"];
    
    // === DEĞİŞİKLİK BURADA: getMockData fonksiyonu geri eklendi (fallback olarak) ===
    const getMockData = (period) => {
        const data = {
            '7d':  { "Bitcoin": 2.5, "Bist 100": 1.1, "Gram Altın": 0.5, "Euro": -0.2, "Dolar": -0.1, "Enflasyon": 0.8 },
            '30d': { "Bitcoin": 10.2, "Bist 100": 4.5, "Gram Altın": 2.1, "Euro": 1.3, "Dolar": 1.0, "Enflasyon": 3.5 },
            '1q':  { "Bitcoin": -5.0, "Bist 100": 8.0, "Gram Altın": 6.5, "Euro": 3.0, "Dolar": 2.8, "Enflasyon": 10.0 },
            '1y':  { "Bitcoin": 80.5, "Bist 100": 45.2, "Gram Altın": 60.1, "Euro": 55.3, "Dolar": 54.0, "Enflasyon": 65.0 },
            'ytd': { "Bitcoin": 60.1, "Bist 100": 35.8, "Gram Altın": 50.2, "Euro": 48.1, "Dolar": 47.5, "Enflasyon": 55.0 }
        };
        return data[period] || data['ytd'];
    };

    const CORS_PROXY = "https://api.allorigins.win/raw?url=";

    async function fetchWithTimeout(resource, options = {}, timeout = 8000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
    }

    async function scrapeData(url) {
        try {
            const response = await fetchWithTimeout(CORS_PROXY + encodeURIComponent(url));
            if (!response.ok) return 0;
            const html = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const changeElement = doc.querySelector('[data-test="instrument-price-change-percent"]');
            if (!changeElement) return 0;
            const value = parseFloat(changeElement.textContent.replace(/[()%\+]/g, '').replace(',', '.'));
            return isNaN(value) ? 0 : value;
        } catch (error) {
            console.error('Veri çekme hatası:', url, error);
            return 0;
        }
    }

    async function getLiveBenchmarkData(period) {
        const urls = {
            "Bitcoin": "https://www.investing.com/crypto/bitcoin/btc-usd",
            "Bist 100": "https://www.investing.com/indices/ise-100",
            "Gram Altın": "https://www.investing.com/commodities/gold-spot",
            "Euro": "https://www.investing.com/currencies/eur-try",
            "Dolar": "https://www.investing.com/currencies/usd-try"
        };
        const promises = Object.entries(urls).map(([name, url]) => 
            scrapeData(url).then(value => ({ name, value }))
        );
        const results = await Promise.all(promises);
        const data = {};
        results.forEach(result => { data[result.name] = result.value; });

        // Eğer tüm sonuçlar 0 ise (büyük ihtimalle scrape başarısız oldu), hata fırlat
        const allZero = Object.values(data).every(val => val === 0);
        if(allZero) {
            throw new Error("Tüm veriler sıfır döndü, scrape başarısız olmuş olabilir.");
        }

        data["Enflasyon"] = 3.5; 
        return data;
    }

    const getMockCurrentPrice = (hisse) => Math.random() * 100 + 20;
    const getMockUsdTry = () => 33.50;

    const tabs = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    function saveData() { localStorage.setItem('portfolioData', JSON.stringify(state)); }

    function loadData() {
        const data = localStorage.getItem('portfolioData');
        const defaultState = {
            transactions: [],
            kasa: { baslangic: 100000, hareketler: [] },
            notes: [],
            activeTab: 'dashboard',
            sortState: { key: 'cikisTarihi', order: 'desc' }
        };
        if (data) {
            const savedState = JSON.parse(data);
            state = { ...defaultState, ...savedState };
            state.kasa = { ...defaultState.kasa, ...(savedState.kasa || {}) };
            state.transactions = savedState.transactions || [];
            state.notes = savedState.notes || [];
            state.sortState = savedState.sortState || defaultState.sortState;
        } else {
            state = defaultState;
        }
    }

    function populateHisseList() {
        const datalist = document.getElementById('hisse-listesi');
        BIST_SYMBOLS.forEach(symbol => {
            const option = document.createElement('option');
            option.value = symbol;
            datalist.appendChild(option);
        });
    }

    function calculateGuncelKasa() {
        let guncelKasa = state.kasa.baslangic || 0;
        (state.kasa.hareketler || []).forEach(h => { guncelKasa += h.tutar; });
        getClosedTransactions().forEach(t => { if (t.netPnlTL) guncelKasa += t.netPnlTL; });
        return guncelKasa;
    }
    
    function getOpenTransactions() { return (state.transactions || []).filter(t => !t.isClosed); }
    function getClosedTransactions() { return (state.transactions || []).filter(t => t.isClosed); }

    function renderAll() {
        renderDashboard();
        renderIslemlerTables();
        renderAnaliz();
        if (document.getElementById('karsilastirma').classList.contains('active')) {
            renderKarsilastirma();
        }
        renderNotes();
    }

    function renderDashboard() {
        const closedTrades = getClosedTransactions();
        const winningTrades = closedTrades.filter(t => t.netPnlTL > 0).length;
        const totalGain = closedTrades.filter(t => t.netPnlTL > 0).reduce((sum, t) => sum + t.netPnlTL, 0);
        const totalLoss = Math.abs(closedTrades.filter(t => t.netPnlTL < 0).reduce((sum, t) => sum + t.netPnlTL, 0));
        const totalReturnTL = closedTrades.reduce((sum, t) => sum + t.netPnlTL, 0);
        const initialCapitalForPnl = (state.kasa.baslangic || 0) + (state.kasa.hareketler || []).filter(h => h.tutar > 0).reduce((sum, h) => sum + h.tutar, 0);
        const totalReturnYuzde = initialCapitalForPnl > 0 ? (totalReturnTL / initialCapitalForPnl) * 100 : 0;
        const winRate = closedTrades.length > 0 ? (winningTrades / closedTrades.length) * 100 : 0;
        const profitFactor = totalLoss > 0 ? totalGain / totalLoss : 0;
        const ortalamaGun = closedTrades.length > 0 ? closedTrades.reduce((sum, t) => sum + t.gun, 0) / closedTrades.length : 0;
        
        document.getElementById('dashboard-toplam-getiri-yuzde').innerHTML = `${(totalReturnYuzde || 0).toFixed(2)}%`;
        document.getElementById('dashboard-toplam-getiri-tl').innerHTML = `${(totalReturnTL || 0).toFixed(2)} TL`;
        document.getElementById('dashboard-kazanma-orani').innerHTML = `${(winRate || 0).toFixed(2)}%`;
        document.getElementById('dashboard-profit-factor').innerHTML = (profitFactor || 0).toFixed(2);
        document.getElementById('dashboard-tamamlanan-islem').innerHTML = closedTrades.length;
        document.getElementById('dashboard-ortalama-gun').innerHTML = `${(ortalamaGun || 0).toFixed(0)} gün`;
        document.getElementById('dashboard-guncel-kasa').innerHTML = `${calculateGuncelKasa().toFixed(2)} TL`;
        
        document.querySelectorAll('.value').forEach(el => {
            const value = parseFloat(el.textContent);
            el.classList.remove('positive', 'negative');
            if (value > 0) el.classList.add('positive');
            else if (value < 0) el.classList.add('negative');
        });

        renderKasaChart();
        renderWinRatePieChart();
    }

    function renderWinRatePieChart() {
        const closedTrades = getClosedTransactions();
        const winningTrades = closedTrades.filter(t => t.netPnlTL > 0).length;
        const losingTrades = closedTrades.length - winningTrades;

        const data = {
            labels: [`Kazanan (${winningTrades})`, `Kaybeden (${losingTrades})`],
            datasets: [{
                data: [winningTrades, losingTrades],
                backgroundColor: ['#4caf50', '#f44336'],
                borderColor: '#2a2a2a',
                borderWidth: 3,
                hoverOffset: 4
            }]
        };

        const options = {
            responsive: true,
            plugins: {
                legend: { 
                    display: true,
                    position: 'bottom',
                    labels: {
                        color: 'var(--text-muted-color)',
                        boxWidth: 12,
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            const value = context.raw;
                            const percentage = closedTrades.length > 0 ? (value / closedTrades.length * 100).toFixed(1) : 0;
                            label += `${percentage}%`;
                            return label;
                        }
                    }
                }
            }
        };

        const ctx = document.getElementById('winRatePieChart').getContext('2d');
        if (winRatePieChartInstance) {
            winRatePieChartInstance.destroy();
        }
        
        if(closedTrades.length > 0){
             winRatePieChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: options
            });
        }
    }

    function renderIslemlerTables() {
        const acikTbody = document.querySelector('#acikPozisyonlarTable tbody');
        const kapaliTbody = document.querySelector('#kapaliPozisyonlarTable tbody');
        acikTbody.innerHTML = '';
        kapaliTbody.innerHTML = '';
        
        const guncelKasa = calculateGuncelKasa();
        const openTransactions = getOpenTransactions().sort((a, b) => new Date(b.girisTarihi) - new Date(a.girisTarihi));
        let closedTransactions = getClosedTransactions();

        const { key, order } = state.sortState;
        if (key) {
            closedTransactions.sort((a, b) => {
                const valA = a[key] || (key.toLowerCase().includes('tarih') ? '' : 0);
                const valB = b[key] || (key.toLowerCase().includes('tarih') ? '' : 0);

                let comparison = 0;
                if (key.toLowerCase().includes('tarih')) {
                    comparison = new Date(valA) - new Date(valB);
                } else if (typeof valA === 'string') {
                    comparison = valA.localeCompare(valB);
                } else {
                    comparison = valA - valB;
                }
                return order === 'asc' ? comparison : -comparison;
            });
        }

        openTransactions.forEach((t) => {
            const girisFiyati = t.girisFiyati || 0;
            const girisLot = t.girisLot || 0;
            const pozBuyuklugu = guncelKasa > 0 ? ((girisFiyati * girisLot) / guncelKasa) * 100 : 0;
            const gun = Math.round((new Date() - new Date(t.girisTarihi)) / (1000 * 60 * 60 * 24));
            const girisFee = girisFiyati * girisLot * FEE_RATE;
            const guncelFiyat = getMockCurrentPrice(t.hisse);
            const girisHacmi = t.girisFiyati * t.girisLot;
            const anlikPnlTL = (guncelFiyat * t.girisLot) - girisHacmi - girisFee;
            const anlikPnlYuzde = girisHacmi > 0 ? ((guncelFiyat * t.girisLot - girisHacmi) / girisHacmi) * 100 : 0;
            const row = document.createElement('tr');
            row.innerHTML = `<td>${t.hisse ? t.hisse.toUpperCase() : 'BİLİNMİYOR'}</td><td>${pozBuyuklugu.toFixed(2)}%</td><td>${t.girisTarihi ? new Date(t.girisTarihi).toLocaleDateString('tr-TR') : '-'}</td><td>${girisLot}</td><td>${girisFiyati.toFixed(2)}</td><td>${guncelFiyat.toFixed(2)}</td><td>-</td><td>-</td><td>-</td><td>${gun}</td><td>${girisFee.toFixed(2)}</td><td class="${anlikPnlYuzde >= 0 ? 'positive' : 'negative'}">${anlikPnlYuzde.toFixed(2)}%</td><td class="${anlikPnlTL >= 0 ? 'positive' : 'negative'}">${anlikPnlTL.toFixed(2)}</td><td>-</td><td><a href="${t.tradingviewLink || '#'}" target="_blank" title="${t.tradingviewLink || ''}">${t.tradingviewLink ? '🔗' : ''}</a></td><td><button class="action-btn" onclick="app.openModal(${t.originalIndex}, 'close')" title="Pozisyonu Kapat">✖️</button><button class="action-btn" onclick="app.openModal(${t.originalIndex}, 'edit')" title="Düzenle">✏️</button><button class="action-btn" onclick="app.deleteTransaction(${t.originalIndex})" title="Sil">🗑️</button></td>`;
            acikTbody.appendChild(row);
        });
        
        closedTransactions.forEach((t) => {
            const girisFiyati = t.girisFiyati || 0;
            const girisLot = t.girisLot || 0;
            const pozBuyuklugu = guncelKasa > 0 ? ((girisFiyati * girisLot) / guncelKasa) * 100 : 0;
            const cikisFiyati = t.cikisFiyati || 0;
            const toplamFee = t.toplamFee || 0;
            const netPnlYuzde = t.netPnlYuzde || 0;
            const netPnlTL = t.netPnlTL || 0;
            const kasayaEtkisi = t.kasayaEtkisi || 0;
            const row = document.createElement('tr');
            row.innerHTML = `<td>${t.hisse ? t.hisse.toUpperCase() : 'BİLİNMİYOR'}</td><td>${pozBuyuklugu.toFixed(2)}%</td><td>${t.girisTarihi ? new Date(t.girisTarihi).toLocaleDateString('tr-TR') : '-'}</td><td>${girisLot}</td><td>${girisFiyati.toFixed(2)}</td><td>-</td><td>${t.cikisTarihi ? new Date(t.cikisTarihi).toLocaleDateString('tr-TR') : '-'}</td><td>${t.cikisLot || 0}</td><td>${cikisFiyati.toFixed(2)}</td><td>${t.gun || 0}</td><td>${toplamFee.toFixed(2)}</td><td class="${netPnlYuzde >= 0 ? 'positive' : 'negative'}">${netPnlYuzde.toFixed(2)}%</td><td class="${netPnlTL >= 0 ? 'positive' : 'negative'}">${netPnlTL.toFixed(2)}</td><td>${kasayaEtkisi.toFixed(2)}%</td><td><a href="${t.tradingviewLink || '#'}" target="_blank" title="${t.tradingviewLink || ''}">${t.tradingviewLink ? '🔗' : ''}</a></td><td><button class="action-btn" onclick="app.reopenTransaction(${t.originalIndex})" title="Yeniden Aç">🔄</button><button class="action-btn" onclick="app.deleteTransaction(${t.originalIndex})" title="Sil">🗑️</button></td>`;
            kapaliTbody.appendChild(row);
        });

        document.querySelectorAll('#kapaliPozisyonlarTable thead th .sort-indicator').forEach(ind => ind.remove());
        const activeTh = document.querySelector(`#kapaliPozisyonlarTable thead th[data-sort-key="${key}"]`);
        if (activeTh) {
            const indicator = document.createElement('span');
            indicator.className = 'sort-indicator';
            indicator.textContent = order === 'desc' ? '▼' : '▲';
            activeTh.appendChild(indicator);
        }
    }

    function renderAnaliz() {
        const activeFilter = document.querySelector('#analiz-filter .active').dataset.period;
        const now = new Date();
        let startDate = new Date('1970-01-01');
        if (activeFilter === 'ytd') startDate = new Date(now.getFullYear(), 0, 1);
        else if (activeFilter === '1y') startDate.setFullYear(now.getFullYear() - 1);
        else if (activeFilter === '1q') startDate.setMonth(now.getMonth() - 3);
        else if (activeFilter === '30d') startDate.setDate(now.getDate() - 30);
        else if (activeFilter === '7d') startDate.setDate(now.getDate() - 7);
        
        const filteredTrades = getClosedTransactions().filter(t => new Date(t.cikisTarihi) >= startDate);
        
        const bestTradeContent = document.getElementById('best-trade-content');
        const worstTradeContent = document.getElementById('worst-trade-content');
        let bestTrade = null;
        let worstTrade = null;

        if (filteredTrades.length > 0) {
            const sortedByPnl = [...filteredTrades].sort((a, b) => (b.netPnlTL || 0) - (a.netPnlTL || 0));
            if (sortedByPnl[0].netPnlTL > 0) {
                bestTrade = sortedByPnl[0];
            }
            if (sortedByPnl[sortedByPnl.length - 1].netPnlTL < 0) {
                worstTrade = sortedByPnl[sortedByPnl.length - 1];
            }
        }

        if (bestTrade) {
            bestTradeContent.innerHTML = `<div class="trade-details"><p class="hisse-adi">${bestTrade.hisse.toUpperCase()}</p><p>Net Kâr (TL):<span class="positive pnl-value">${(bestTrade.netPnlTL || 0).toFixed(2)} TL</span></p><p>Net Kâr (%):<span class="positive">${(bestTrade.netPnlYuzde || 0).toFixed(2)}%</span></p><p>Pozisyon Süresi: <span>${bestTrade.gun} gün</span></p><p>Tarihler: <span>${new Date(bestTrade.girisTarihi).toLocaleDateString('tr-TR')} - ${new Date(bestTrade.cikisTarihi).toLocaleDateString('tr-TR')}</span></p><p>TradingView: <span>${bestTrade.tradingviewLink ? `<a href="${bestTrade.tradingviewLink}" target="_blank">Grafiği Gör 🔗</a>` : '-'}</span></p></div>`;
        } else {
            bestTradeContent.innerHTML = `<p class="placeholder">Bu dönemde kazanan işlem bulunmuyor.</p>`;
        }

        if (worstTrade) {
            worstTradeContent.innerHTML = `<div class="trade-details"><p class="hisse-adi">${worstTrade.hisse.toUpperCase()}</p><p>Net Zarar (TL):<span class="negative pnl-value">${(worstTrade.netPnlTL || 0).toFixed(2)} TL</span></p><p>Net Zarar (%):<span class="negative">${(worstTrade.netPnlYuzde || 0).toFixed(2)}%</span></p><p>Pozisyon Süresi: <span>${worstTrade.gun} gün</span></p><p>Tarihler: <span>${new Date(worstTrade.girisTarihi).toLocaleDateString('tr-TR')} - ${new Date(worstTrade.cikisTarihi).toLocaleDateString('tr-TR')}</span></p><p>TradingView: <span>${worstTrade.tradingviewLink ? `<a href="${worstTrade.tradingviewLink}" target="_blank">Grafiği Gör 🔗</a>` : '-'}</span></p></div>`;
        } else {
            worstTradeContent.innerHTML = `<p class="placeholder">Bu dönemde kaybeden işlem bulunmuyor.</p>`;
        }
        
        const totalTrades = filteredTrades.length;
        const winningTrades = filteredTrades.filter(t => t.netPnlTL > 0);
        const losingTrades = filteredTrades.filter(t => t.netPnlTL < 0);
        const winRate = totalTrades > 0 ? (winningTrades.length / totalTrades) * 100 : 0;
        const totalGain = winningTrades.reduce((sum, t) => sum + (t.netPnlTL || 0), 0);
        const totalLoss = Math.abs(losingTrades.reduce((sum, t) => sum + (t.netPnlTL || 0), 0));
        const netPnlTL = totalGain - totalLoss;
        const netPnlYuzde = calculateGuncelKasa() > 0 ? (netPnlTL / calculateGuncelKasa()) * 100 : 0;
        const avgWinYuzde = winningTrades.length > 0 ? winningTrades.reduce((sum, t) => sum + (t.netPnlYuzde || 0), 0) / winningTrades.length : 0;
        const avgWinTL = winningTrades.length > 0 ? totalGain / winningTrades.length : 0;
        const avgLossYuzde = losingTrades.length > 0 ? losingTrades.reduce((sum, t) => sum + (t.netPnlYuzde || 0), 0) / losingTrades.length : 0;
        const avgLossTL = losingTrades.length > 0 ? totalLoss / losingTrades.length : 0;
        const avgDays = totalTrades > 0 ? filteredTrades.reduce((sum, t) => sum + (t.gun || 0), 0) / totalTrades : 0;
        const profitFactor = totalLoss > 0 ? totalGain / totalLoss : 0;
        
        const analysisData = [ { label: 'Açılan Pozisyon Sayısı', value: totalTrades, unit: '' }, { label: 'Win Rate', value: winRate, unit: '%' }, { label: 'Kazananların Ort. (%)', value: avgWinYuzde, unit: '%' }, { label: 'Kazananların Ort. (TL)', value: avgWinTL, unit: ' TL' }, { label: 'Kaybedenlerin Ort. (%)', value: avgLossYuzde, unit: '%' }, { label: 'Kaybedenlerin Ort. (TL)', value: avgLossTL, unit: ' TL' }, { label: 'Ortalama Gün Sayısı', value: avgDays, unit: ' gün' }, { label: 'Profit Factor', value: profitFactor, unit: '' }, { label: 'Net PnL (TL)', value: netPnlTL, unit: ' TL' }, { label: 'Net PnL (%)', value: netPnlYuzde, unit: '%' }];
        const analizGrid = document.getElementById('analiz-grid');
        analizGrid.innerHTML = '';
        analysisData.forEach(item => {
            const card = `<div class="card"><div class="label">${item.label}</div><div class="value ${item.value > 0 ? 'positive' : item.value < 0 ? 'negative' : ''}">${(item.value || 0).toFixed(2)}${item.unit}</div></div>`;
            analizGrid.innerHTML += card;
        });
    }

    async function renderKarsilastirma() {
        if (!document.getElementById('karsilastirma').classList.contains('active')) return;
        
        const chartContainer = document.getElementById('karsilastirmaChartContainer');
        const canvas = document.getElementById('karsilastirmaChart');
        chartContainer.innerHTML = '<div class="loader">Canlı karşılaştırma verileri yükleniyor...</div>';
        
        const period = document.querySelector('#karsilastirma-filter .active').dataset.period;
        const isReel = document.querySelector('#reel-btn').classList.contains('active');
        
        let benchmarkData;
        try {
            benchmarkData = await getLiveBenchmarkData(period);
            console.log("Canlı veri başarıyla çekildi:", benchmarkData);
        } catch (error) {
            console.error("Canlı veri çekilemedi, statik verilere dönülüyor.", error);
            benchmarkData = getMockData(period); 
            chartContainer.innerHTML = '<div class="loader">Canlı veri alınamadı, örnek veriler gösteriliyor...</div>';
        }
        
        chartContainer.innerHTML = '';
        chartContainer.appendChild(canvas);

        const enflasyon = benchmarkData['Enflasyon'] || 0;
        const now = new Date();
        let startDate = new Date();
        if (period === 'ytd') startDate = new Date(now.getFullYear(), 0, 1);
        else if (period === '1y') startDate.setFullYear(now.getFullYear() - 1);
        else if (period === '1q') startDate.setMonth(now.getMonth() - 3);
        else if (period === '30d') startDate.setDate(now.getDate() - 30);
        else if (period === '7d') startDate.setDate(now.getDate() - 7);
        
        const filteredTrades = getClosedTransactions().filter(t => new Date(t.cikisTarihi) >= startDate);
        const pnl = filteredTrades.reduce((sum, t) => sum + (t.netPnlTL || 0), 0);
        const initialCapitalForPeriod = calculateGuncelKasa() - pnl;
        const myPerformance = initialCapitalForPeriod > 0 ? (pnl / initialCapitalForPeriod) * 100 : 0;
        
        let data = { ...benchmarkData };
        delete data['Enflasyon'];
        data['Portföy Performansı'] = myPerformance;
        
        let labels = Object.keys(data);
        let values = Object.values(data);
        
        if (isReel) { values = values.map(v => v - enflasyon); }
        
        const chartData = {
            labels: labels,
            datasets: [{
                label: (isReel ? 'Reel' : 'Nominal') + ' Getiri',
                data: values,
                backgroundColor: (context) => {
                    const value = context.raw || 0;
                    const maxPositive = Math.max(...values.filter(v => v > 0), 0);
                    const minNegative = Math.min(...values.filter(v => v < 0), 0);
                    if (value >= 0) { const intensity = maxPositive > 0 ? (value / maxPositive) * 0.6 + 0.4 : 1; return `rgba(76, 175, 80, ${intensity})`; }
                    else { const intensity = minNegative < 0 ? (value / minNegative) * 0.6 + 0.4 : 1; return `rgba(244, 67, 54, ${intensity})`; }
                },
                borderColor: 'rgba(0,0,0,0)', borderWidth: 1
            }]
        };
        const ctx = document.getElementById('karsilastirmaChart').getContext('2d');
        if (karsilastirmaChartInstance) karsilastirmaChartInstance.destroy();
        karsilastirmaChartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: { indexAxis: 'y', scales: { x: { position: 'center', ticks: { color: 'white', callback: (value) => value + '%' }, grid: { color: 'rgba(255,255,255,0.1)' } }, y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (context) => `${context.label}: ${(context.raw || 0).toFixed(2)}%` } } } } });
    }

    function renderKasaChart() {
        if (!document.getElementById('dashboard').classList.contains('active')) return;
        const type = document.querySelector('#kasaChartContainer .filter-buttons .active').id.split('-')[1];
        const closedTrades = getClosedTransactions().sort((a,b) => new Date(a.cikisTarihi) - new Date(b.cikisTarihi));
        let labels = [new Date(new Date().getFullYear(), 0, 1).toLocaleDateString('tr-TR')];
        let dataPoints = [state.kasa.baslangic || 0];
        let cumulativePnl = 0;
        closedTrades.forEach(t => {
            cumulativePnl += t.netPnlTL || 0;
            labels.push(new Date(t.cikisTarihi).toLocaleDateString('tr-TR'));
            dataPoints.push((state.kasa.baslangic || 0) + cumulativePnl);
        });
        let finalData = dataPoints;
        let label = 'Kasa Değeri (TRY)';
        const usdRate = getMockUsdTry();
        if(type === 'usd') { finalData = dataPoints.map(val => val / usdRate); label = 'Kasa Değeri (USD)'; }
        else if (type === 'reel') { finalData = dataPoints.map((val, index) => val / Math.pow(1.01, index)); label = 'Reel Kasa Değeri (TRY)'; }
        const chartData = {
            labels: labels,
            datasets: [{ label: label, data: finalData, fill: false, borderColor: 'rgb(3, 218, 198)', tension: 0.1 }]
        };
        const ctx = document.getElementById('kasaChart').getContext('2d');
        if (kasaChartInstance) kasaChartInstance.destroy();
        kasaChartInstance = new Chart(ctx, { type: 'line', data: chartData, options: { scales: { y: { ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { labels: { color: 'white' } } } }});
    }
    
    function renderNotes() {
        const noteList = document.getElementById('noteList');
        noteList.innerHTML = '';
        const reversedNotes = [...(state.notes || [])].reverse();
        reversedNotes.forEach((note, reversedIndex) => {
            const originalIndex = state.notes.length - 1 - reversedIndex;
            const li = document.createElement('li');
            li.className = 'note-item';
            li.innerHTML = `
                <p>${note.replace(/\n/g, '<br>')}</p>
                <div class="note-actions">
                    <button class="action-btn" onclick="app.editNote(${originalIndex})" title="Düzenle">✏️</button>
                    <button class="action-btn" onclick="app.deleteNote(${originalIndex})" title="Sil">🗑️</button>
                </div>`;
            noteList.appendChild(li);
        });
    }
    
    function resetIslemForm() {
        document.getElementById('hisse').value = '';
        document.getElementById('girisLot').value = '';
        document.getElementById('girisFiyat').value = '';
        document.getElementById('tradingviewLink').value = '';
        document.getElementById('editIndex').value = '';
        document.getElementById('girisTarihi').value = new Date().toISOString().split('T')[0];
        document.getElementById('islemEkleBtn').textContent = 'Yeni Pozisyon Ekle';
    }

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            state.activeTab = tab.dataset.tab;
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === state.activeTab) { content.classList.add('active'); }
            });
            renderAll();
        });
    });

    document.getElementById('islemEkleBtn').addEventListener('click', () => {
        const hisse = document.getElementById('hisse').value;
        const girisLot = parseFloat(document.getElementById('girisLot').value);
        const girisFiyati = parseFloat(document.getElementById('girisFiyat').value);
        const girisTarihi = document.getElementById('girisTarihi').value; 
        const tradingviewLink = document.getElementById('tradingviewLink').value;
        const editIndex = document.getElementById('editIndex').value;
        if (!hisse || !girisLot || !girisFiyati) { alert('Lütfen Hisse, Lot ve Fiyat alanlarını doldurun.'); return; }
        if (editIndex !== "") {
            const transaction = state.transactions[parseInt(editIndex)];
            Object.assign(transaction, { hisse, girisLot, girisFiyati, girisTarihi, tradingviewLink });
        } else {
            state.transactions.push({ hisse, girisLot, girisFiyati, girisTarihi, tradingviewLink, isClosed: false });
        }
        (state.transactions || []).forEach((t, i) => t.originalIndex = i);
        saveData();
        renderAll();
        resetIslemForm(); 
    });
    
    document.getElementById('tumunuSilBtn').addEventListener('click', () => {
        if (confirm('Emin misiniz? Tüm açık ve kapalı pozisyonlarınız kalıcı olarak silinecek. Bu işlem geri alınamaz.')) {
            state.transactions = [];
            saveData();
            renderAll();
            alert('Tüm pozisyonlar başarıyla silindi.');
        }
    });

    document.getElementById('kasaKaydetBtn').addEventListener('click', () => {
        state.kasa.baslangic = parseFloat(document.getElementById('baslangicKasa').value) || 0;
        saveData();
        renderAll();
        alert('Başlangıç kasası güncellendi.');
    });
    
    document.getElementById('kasaEkleBtn').addEventListener('click', () => {
        const tutar = parseFloat(document.getElementById('kasaIslemTutar').value);
        if (tutar > 0) {
            if(!state.kasa.hareketler) state.kasa.hareketler = [];
            state.kasa.hareketler.push({ tarih: new Date().toISOString(), tutar: tutar, tip: 'ekleme' });
            saveData();
            renderAll();
            document.getElementById('kasaIslemTutar').value = '';
        }
    });

    document.getElementById('kasaCikarBtn').addEventListener('click', () => {
        const tutar = parseFloat(document.getElementById('kasaIslemTutar').value);
        if (tutar > 0) {
            if(!state.kasa.hareketler) state.kasa.hareketler = [];
            state.kasa.hareketler.push({ tarih: new Date().toISOString(), tutar: -tutar, tip: 'cikarma' });
            saveData();
            renderAll();
            document.getElementById('kasaIslemTutar').value = '';
        }
    });
    
    const modal = document.getElementById('modal');
    document.getElementById('modalKapatBtn').addEventListener('click', () => modal.style.display = 'none');
    document.getElementById('modalKaydetBtn').addEventListener('click', () => {
        const index = parseInt(document.getElementById('modalIndex').value);
        const cikisFiyati = parseFloat(document.getElementById('modalCikisFiyat').value);
        const cikisLot = parseFloat(document.getElementById('modalCikisLot').value);
        const cikisTarihi = document.getElementById('modalCikisTarihi').value; 
        if (!cikisFiyati || !cikisLot) { alert('Fiyat ve Lot girin.'); return; }
        const transaction = state.transactions[index];
        if (cikisLot > transaction.girisLot) { alert('Kapatılan lot, pozisyon büyüklüğünden fazla olamaz.'); return; }
        const kasaOnce = calculateGuncelKasa();
        const girisHacmi = transaction.girisFiyati * cikisLot;
        const cikisHacmi = cikisFiyati * cikisLot;
        const girisFee = girisHacmi * FEE_RATE;
        const cikisFee = cikisHacmi * FEE_RATE;
        const toplamFee = girisFee + cikisFee;
        const netPnlTL = (cikisFiyati - transaction.girisFiyati) * cikisLot - toplamFee;
        const netPnlYuzde = girisHacmi > 0 ? (netPnlTL / girisHacmi) * 100 : 0;
        const gun = Math.round((new Date(cikisTarihi) - new Date(transaction.girisTarihi)) / (1000 * 60 * 60 * 24));
        const kasayaEtkisi = kasaOnce > 0 ? (netPnlTL / kasaOnce) * 100 : 0;
        if (cikisLot < transaction.girisLot) {
            state.transactions.push({ ...transaction, girisLot: cikisLot, cikisTarihi, cikisLot, cikisFiyati, gun, toplamFee, netPnlTL, netPnlYuzde, kasayaEtkisi, isClosed: true, isPartial: true, });
            transaction.girisLot -= cikisLot;
        } else { Object.assign(transaction, { cikisTarihi, cikisLot, cikisFiyati, gun, toplamFee, netPnlTL, netPnlYuzde, kasayaEtkisi, isClosed: true }); }
        (state.transactions || []).forEach((t, i) => t.originalIndex = i);
        saveData();
        renderIslemlerTables();
        modal.style.display = 'none';
    });

    document.querySelectorAll('#analiz-filter button, #karsilastirma-filter button').forEach(button => { button.addEventListener('click', (e) => { e.target.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if (state.activeTab === 'analiz' || state.activeTab === 'karsilastirma') renderAll(); }); });
    document.querySelectorAll('#kasaChartContainer .filter-buttons button').forEach(button => { button.addEventListener('click', (e) => { e.target.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); if (state.activeTab === 'dashboard') renderKasaChart(); }); });
    
    document.getElementById('addNoteBtn').addEventListener('click', () => { const noteInput = document.getElementById('noteInput'); const noteEditIndex = document.getElementById('noteEditIndex'); if (noteInput.value.trim() === '') return; if(noteEditIndex.value !== '') { state.notes[noteEditIndex.value] = noteInput.value; } else { state.notes.push(noteInput.value); } noteInput.value = ''; noteEditIndex.value = ''; document.getElementById('addNoteBtn').textContent = 'Not Ekle'; saveData(); renderNotes(); });
    document.getElementById('exportNotesBtn').addEventListener('click', () => { const notesText = (state.notes || []).join('\n\n---\n\n'); const blob = new Blob([notesText], { type: 'text/plain' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'notlarim.txt'; link.click(); });
    
    const importNotesInput = document.getElementById('importNotesInput');
    document.getElementById('importNotesBtn').addEventListener('click', () => { importNotesInput.click(); });
    importNotesInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const content = e.target.result;
            const newNotes = content.split('\n\n---\n\n').filter(note => note.trim() !== '');
            if (newNotes.length > 0) {
                state.notes.push(...newNotes);
                saveData();
                renderNotes();
                alert(`${newNotes.length} adet not başarıyla içe aktarıldı.`);
            }
            importNotesInput.value = '';
        };
        reader.onerror = () => { alert('Dosya okunurken bir hata oluştu.'); importNotesInput.value = ''; }
        reader.readAsText(file);
    });

    document.getElementById('toggleKapaliPozisyonlar').addEventListener('click', (e) => { const container = document.getElementById('kapaliPozisyonlarContainer'); if (container.style.display === 'none' || container.style.display === '') { container.style.display = 'block'; e.target.textContent = 'Kapalı Pozisyonları Gizle'; } else { container.style.display = 'none'; e.target.textContent = 'Kapalı Pozisyonları Göster'; } });
    
    window.app = {
        openModal: (index, type) => { const transaction = state.transactions[index]; if (!transaction) return; document.getElementById('modalIndex').value = index; if (type === 'close') { document.getElementById('modalTitle').textContent = `Pozisyon Kapat: ${transaction.hisse}`; document.getElementById('modalCikisLot').value = transaction.girisLot; document.getElementById('modalCikisFiyat').placeholder = "Güncel Fiyat"; document.getElementById('modalCikisTarihi').value = new Date().toISOString().split('T')[0]; modal.style.display = 'flex'; } else if (type === 'edit') { document.getElementById('editIndex').value = index; document.getElementById('hisse').value = transaction.hisse; document.getElementById('girisLot').value = transaction.girisLot; document.getElementById('girisFiyat').value = transaction.girisFiyati; document.getElementById('girisTarihi').value = transaction.girisTarihi; document.getElementById('tradingviewLink').value = transaction.tradingviewLink; document.getElementById('islemEkleBtn').textContent = 'Değişiklikleri Kaydet'; window.scrollTo(0,0); } },
        deleteTransaction: (index) => { if (confirm('Bu işlemi silmek istediğinizden emin misiniz?')) { state.transactions.splice(index, 1); (state.transactions || []).forEach((t, i) => t.originalIndex = i); saveData(); renderAll(); } },
        reopenTransaction: (index) => { if (confirm('Bu kapalı işlemi yeniden açmak istediğinizden emin misiniz?')) { const transaction = state.transactions[index]; transaction.isClosed = false; delete transaction.cikisTarihi; delete transaction.cikisLot; delete transaction.cikisFiyati; saveData(); renderIslemlerTables(); } },
        editNote: (index) => { document.getElementById('noteInput').value = state.notes[index]; document.getElementById('noteEditIndex').value = index; document.getElementById('addNoteBtn').textContent = 'Notu Güncelle'; document.getElementById('noteInput').focus(); },
        deleteNote: (index) => { if (confirm('Bu notu silmek istediğinizden emin misiniz?')) { state.notes.splice(index, 1); saveData(); renderNotes(); } }
    };
    
    document.querySelectorAll('#kapaliPozisyonlarTable thead th[data-sort-key]').forEach(th => {
        th.addEventListener('click', () => {
            const newKey = th.dataset.sortKey;
            const currentSort = state.sortState;
            let newOrder = 'desc';
            if (currentSort.key === newKey) {
                newOrder = currentSort.order === 'desc' ? 'asc' : 'desc';
            }
            state.sortState = { key: newKey, order: newOrder };
            saveData(); 
            renderIslemlerTables();
        });
    });

    loadData();
    populateHisseList(); 
    if (!state.transactions) state.transactions = [];
    state.transactions.forEach((t, i) => t.originalIndex = i);
    document.querySelector(`.tab-button[data-tab="dashboard"]`).click();
    resetIslemForm(); 
    renderAll();
});
</script>
</body>
</html>
